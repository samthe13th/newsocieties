<div *ngIf="showModal === true" class="modal-wrap">
  <div class="modal small">
    <button
      class="cancel-button"
      (click)="closeModal()">
      Cancel
    </button>
    <ng-container *ngTemplateOutlet="modalContent"></ng-container>
  </div>
</div>

<app-tabs 
  class="host-side-panel"
  selectedClass="host-selected-tab"
  [tabs]="[
    { id: 'division', tabTemplate: division, bodyTemplate: divisionBody },
    { id: 'global', tabTemplate: global, bodyTemplate: globalBody },
    { id: 'exports', tabTemplate: exports, bodyTemplate: exportsBody },
    { id: 'central', tabTemplate: central, bodyTemplate: centralBody }
  ]">
</app-tabs>

<app-tabs 
  class="host-side-panel"
  selectedClass="host-selected-tab"
  (tabChange)="onRightTabChange($event)"
  [tabs]="[
    { id: 'focus', tabTemplate: focusTab, bodyTemplate: focusBody },
    { id: 'notifications', tabTemplate: notifications, bodyTemplate: notificationsBody }
  ]">
</app-tabs>

<ng-template #notifications>
  Inbox 
  <span *ngIf="($unseenNotifications | async) as list">
    <ng-container *ngIf="list.length > 0 && rightTab !== 'notifications'">
      ({{ list?.length }})
    </ng-container>
  </span>
</ng-template>
<ng-template #focusTab>Focus</ng-template>

<ng-template #notificationsBody>
  <app-notification-feed
    [showKey]="showKey"
    [divisionKey]="divisionKey">
  </app-notification-feed>
</ng-template>

<ng-template #focusBody>
  <div class="host-main" *ngIf="focus">
    <app-button-group
      #focusButtonsComponent
      (select)="onFocusSelect($event)"
      [selectById]="focus"
      [buttons]="focusButtons">
    </app-button-group>
    <div *ngIf="focus === 'misc'" class="misc-wrapper">
      Pending GLA requests
    </div>
    <div *ngIf="focus === 'harvest'" class="harvest-wrapper">
      <app-land-grid
        #landGrid
        *ngIf="action === 'harvesting'"
        (gatherResource)="onGather($event)"
        [markCards]="true"
        [showId]="showKey"
        [divisionKey]="divisionKey"
        [updatePath]="landTilesPath"> 
      </app-land-grid>
      <div class="button-row">
        <button (click)="exploreOwnedLand(landGrid)">Flip owned</button>
        <button (click)="gatherOwnedLand(landGrid)">Gather owned</button>
      </div>
      <div class="turn-controls" *ngIf="($turn | async) as turn">
        <ng-container *ngIf="$turnButtons | async as buttons">
          <app-button-group
            (select)="onTurnSelect($event)"
            [selectById]="turn?.id"
            [buttons]="buttons">
          </app-button-group>
        </ng-container>
        <app-player-turn [divisionPath]="divisionPath"></app-player-turn>
      </div>
    </div>
    <div *ngIf="focus === 'principles' || focus === 'resolutions' || focus === 'scenerio'" class="resolution-wrapper">
      <ng-container *ngIf="($vote | async) as vote">
        <app-fundraising
          style="background: black"
          *ngIf="vote?.state === 'review' && vote?.type === 'resolution'"
          [showKey]="showKey"
          [divisionKey]="divisionKey"
          [isCentral]="true"
          (fundsChange)="onFundsChange($event)"
          >
        </app-fundraising>
        <app-vote 
          (selectionChange)="onSelectionChange($event)"
          [showVotes]="true"
          [allowSelection]="vote?.state === 'review'"
          [showId]="showKey"
          role="central"
          [divisionId]="divisionKey"
        ></app-vote>
        <button *ngIf="vote?.state === 'voting'" (click)="closePolls()">Close Polls</button>
        <button *ngIf="vote?.state === 'review' && divisionVote" (click)="implement()">Implement</button>
      </ng-container>
  
    </div>
  </div>  
</ng-template>

<ng-template #harvestTemplate>
  Go to harvest
  <button (click)="startHarvest()">Start</button>
</ng-template>

<ng-template #principleTemplate>
  <h1>Principle</h1>
  <select
    *ngIf="voteDropdown"
    [(ngModel)]="voteDropdownSelect"
    name="vote-options"
    id="vote-options">
    <option
      *ngFor="let option of voteDropdown"
      [ngValue]="option">
      {{option?.title}}
    </option>
  </select>

  <button *ngIf="voteDropdownSelect" (click)="startVote('principles')">Vote on Principle</button>
</ng-template>

<ng-template #resolutionTemplate>
  <h1>Resolution</h1>
  <select
    *ngIf="voteDropdown"
    [(ngModel)]="voteDropdownSelect"
    name="vote-options"
    id="vote-options">
    <option
      *ngFor="let option of voteDropdown"
      [ngValue]="option">
      {{option?.title}}
    </option>
  </select>

  <button *ngIf="voteDropdownSelect" (click)="startVote('resolutions')">Vote on Resolution</button>
</ng-template>

<ng-template #scenerioTemplate>
  <h1>Scenerio</h1>
  <select
    *ngIf="voteDropdown"
    [(ngModel)]="voteDropdownSelect"
    name="vote-options"
    id="vote-options">
    <option
      *ngFor="let option of voteDropdown"
      [ngValue]="option">
      {{option?.title}}
    </option>
  </select>

  <button *ngIf="voteDropdownSelect" (click)="startVote('scenerio')">Vote on Scenerio</button>
</ng-template>

<ng-template #miscTemplate>
  Misc
  <button (click)="startMisc()">Start</button>
</ng-template>

<!-- TABS-->
<ng-template #division>{{divisionKey}} Division</ng-template>
<ng-template #global>Global</ng-template>
<ng-template #exports>Exports</ng-template>
<ng-template #central>Central</ng-template>
<ng-template #notes>Notes</ng-template>

<!-- DIVISION -->
<ng-template #divisionBody>
  <div class="stack" *ngIf="$division | async as division">
    <div class="tab-card">
      <div><strong>Score: </strong>{{ division.score }} ({{ division.VP }})</div>
      <div><strong>Season:</strong>
        {{ division.season }}
        <button (click)="newSeason(division)">New Season</button>
      </div>
      <hr/>

      <div>
        <div>
          <button (click)="changeDivisionProperty('reserve')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Reserve: </strong>
          {{ division.reserve }}
        </div>
        <div>
          <button (click)="changeDivisionProperty('advancements/safety/communal', 'communal safety')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Communal Safety: </strong>{{ division.advancements.safety.communal }}
        </div>
        <div>
          <button (click)="changeDivisionProperty('advancements/health/communal', 'communal health')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Communal Health: </strong>{{ division.advancements.health.communal }}
        </div>
        <div>
          <button (click)="changeDivisionProperty('advancements/arts/communal', 'communal arts')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Communal Arts: </strong>{{ division.advancements.arts.communal }}
        </div>
        <div>
          <button (click)="changeDivisionProperty('advancements/knowledge/communal', 'communal knowledge')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Communal Knowledge: </strong>{{ division.advancements.knowledge.communal }}
        </div>
        <div>
          <button (click)="changeDivisionProperty('advancements/infrastructure/communal', 'communal infrastructure')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <strong>Communal Infrastructure: </strong>{{ division.advancements.infrastructure.communal }}
        </div>
      </div>

      <hr/>
      <div>
        <strong>Land cost: </strong>
        {{ division.landCost }}
      </div>
      <div>
        <strong>Local land: </strong>
        {{ ($localLand | async)?.length }}
      </div>
      <div>
        <strong>Global land: </strong>
        {{ ($globalLand | async)?.length }}
      </div>
      <div><strong>Harvested: </strong>
        {{ division.harvested }} <span *ngIf="division.harvested">({{ percentHarvested(division.harvested, division.capacity) }}% of capacity)</span>
      </div>
      <div>
        <strong>Capacity: </strong>
        {{ division?.capacity }}
      </div>
      <div><strong>Harvest:</strong>
        {{ division?.harvest }}
      </div>

      <div>
        <strong>Thresholds:</strong>
        {{ division?.reserveThresholds.low }} / {{ division?.reserveThresholds.mid }} / {{ division?.reserveThresholds.high }}
      </div>

      <div>
        <strong>High Thresholds Met: </strong>
        {{ division.highThresholdsMet }}
      </div>

      <hr/>

      <div>
        <strong>Safety: </strong>
        {{ division.advancements.safety.individual + division.advancements.safety.communal }}
      </div>
      <div>
        <strong>Health: </strong>
        {{ division.advancements.health.individual + division.advancements.health.communal }}
      </div>
      <div>
        <strong>Arts: </strong>{{ division.advancements.arts.individual + division.advancements.arts.communal }}
      </div>
      <div>
        <strong>Knowledge: </strong>{{ division.advancements.knowledge.individual + division.advancements.knowledge.communal }}
      </div>
      <div>
        <strong>Infrastructure: </strong>{{ division.advancements.infrastructure.individual + division.advancements.infrastructure.communal }}
      </div>


    </div>

    <div class="tab-card">
      <h2>Citizens</h2>
      <div *ngFor="let citizen of ($citizens | async); let index = index" style="margin-bottom: 10px">
        <hr/>
        <div><strong>{{index + 1}}: {{citizen.name}} ({{citizen.id}})</strong></div>
        <div>
          <button (click)="changeCitizenProperty(citizen, 'actions', 'basic')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          Actions: {{ citizen.actions }}
        </div>

        <div>
          Resources: {{ calculateWealth(citizen?.resources) }}
          <button (click)="removeCitizenResources(citizen)">-</button>
          <button (click)="addCitizenResources(citizen)">+</button>
          <button (click)="transferCitizenResources(citizen)">transfer</button>
        </div>

        <div>
          <button (click)="updateCitizenLand(citizen, division?.landCost)">Buy</button>
          Local Land: {{ citizen?.localLand }}
        </div>

        <div>
          <button (click)="changeCitizenProperty(citizen, 'advancements/safety', 'advancement', 'safety')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <button (click)="updateAdvancement('safety', citizen, division?.advancementCosts)">Buy</button>
          Safety: {{ citizen?.advancements.safety }}
        </div>
        <div>
          <button (click)="changeCitizenProperty(citizen, 'advancements/health', 'advancement', 'health')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <button (click)="updateAdvancement('health', citizen, division?.advancementCosts)">Buy</button>
          Health: {{ citizen?.advancements.health }}
        </div>
        <div>
          <button (click)="changeCitizenProperty(citizen, 'advancements/arts', 'advancement', 'arts')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <button (click)="updateAdvancement('arts', citizen, division?.advancementCosts)">Buy</button>
          Arts: {{ citizen?.advancements.arts }}
        </div>
        <div>
          <button (click)="changeCitizenProperty(citizen, 'advancements/knowledge', 'advancement', 'knowledge')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <button (click)="updateAdvancement('knowledge', citizen, division?.advancementCosts)">Buy</button>
          Knowledge: {{ citizen?.advancements.knowledge }}
        </div>
        <div>
          <button (click)="changeCitizenProperty(citizen, 'advancements/infrastructure', 'advancement', 'infrastructure')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          <button (click)="updateAdvancement('infrastructure', citizen, division?.advancementCosts)">Buy</button>
          Infrastructure: {{ citizen?.advancements.infrastructure }}
        </div>
      </div>
    </div>

    <div class="tab-card">
      <h2>Principles</h2>
      <p *ngFor="let principle of $principles | async">
        {{ principle.value }}
      </p>
    </div>

    <div class="tab-card">
      <h2>Resolutions</h2>
      <p *ngFor="let resolution of ($resolutions | async)">
        {{ resolution.value }}
      </p>
    </div>

    <div class="tab-card">
      <h2>Scenerios</h2>
      <p *ngFor="let scenerio of ($scenerios | async)">
        {{ scenerio.value }}
      </p>
    </div>

    <ng-template #newSeasonTemplate>
      <div *ngIf="division.nextSeason as next">
        <h1>New Season: <span class="new-value">{{ next?.season }}</span></h1>
        <div>
          New GLAs:
          <span class="new-value" *ngFor="let gla of ($pendingGLA | async)">{{ gla.division }}</span>
        </div>
        <div>
          <!-- <button (click)="changeDivisionProperty('nextSeason/capacity')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          Capacity: {{ division.capacity }} &#8594;  -->
          Capacity: <span class="new-value">{{ next?.capacity }}</span>
        </div>
        <div>
          <!-- <button (click)="changeDivisionProperty('nextSeason/harvest')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          Harvest: {{ division.harvest }} &#8594;  -->
          Harvest: <span class="new-value">{{ next?.harvest }}</span>
        </div>
        <div>
          <!-- <button (click)="changeDivisionProperty('nextSeason/landCost')">
            <fa-icon size="sm" [icon]="faPen"></fa-icon>
          </button>
          Land Cost: {{ division.landCost }} &#8594;  -->
          Land Cost: <span class="new-value">{{ next?.landCost }}</span>
        </div>
        <div *ngIf="next?.thresholds">
          Thresholds
          <ul style="margin: 0">
            <li>
              <!-- <button (click)="changeDivisionProperty('nextSeason/thresholds/0', 'Low')">
                <fa-icon size="sm" [icon]="faPen"></fa-icon>
              </button>
              Low: {{ division.reserveThresholds.low }}
              &#8594;  -->
              Low: <span class="new-value">{{ next?.thresholds[0] }}</span>
            </li>
            <li>
              <!-- <button (click)="changeDivisionProperty('nextSeason/thresholds/1', 'Low')">
                <fa-icon size="sm" [icon]="faPen"></fa-icon>
              </button>
              Mid: {{ division.reserveThresholds.mid }}
              &#8594;  -->
              Mid: <span class="new-value">{{ next?.thresholds[1] }}</span>
            </li>
            <li>
              <!-- <button (click)="changeDivisionProperty('nextSeason/thresholds/2', 'High')">
                <fa-icon size="sm" [icon]="faPen"></fa-icon>
              </button>
              High: {{ division.reserveThresholds.high }}
              &#8594;  -->
              High: <span class="new-value">{{ next?.thresholds[2] }}</span>
            </li>
          </ul>
        </div>
        <hr/>
        <button (click)="startSeason(division, next)">Start Season</button>
      </div>
    </ng-template>
  </div>

</ng-template>

<!-- GLOBAL -->
<ng-template #globalBody>
  <div
    *ngIf="contamination !== undefined"
    class="tab-card"
  >
    Contamination Level: {{contamination}}%
    <div *ngFor="let div of divisions">
      <hr/>
      <app-society-summary
        *ngIf="(div.listener | async) as division"
        class="division-summary"
        details="full"
        [division]="division">
      </app-society-summary>
    </div>
  </div>
</ng-template>

<!-- EXPORTS -->
<ng-template #exportsBody>
  <div class="tab-card">
    <app-exports
     [showKey]="showKey"
     [divisionKey]="divisionKey">
    </app-exports>
  </div>
</ng-template>

<!-- CENTRAL -->
<ng-template #centralBody>
  <app-chat [sender]="divisionKey" [feedName]="divisionKey" [showKey]="showKey"></app-chat>
  <textarea
    (keydown.enter)="submitChat(divisionKey)"
    class="host-chat-input"
    name="chatInput"
    type="text"
    [(ngModel)]="chatInput">
  </textarea>
  <button class="host-chat-button" (click)="submitChat(divisionKey)">SEND</button>
</ng-template>

<!-- NOTES -->
<ng-template #notesBody>
  <div class="button-row">
    <button [style.font-size.px]="14" (click)="fontSizeDown()">Aa</button>
    <button [style.font-size.px]="20" (click)="fontSizeUp()">Aa</button>
  </div>
  <br/>
  <textarea [style.font-size.px]="fontSize" class="host-notes">Type notes here!</textarea>
</ng-template>

<!-- UPDATE SHEET -->
<ng-template #updateSheet>
  <div class="action-sheet">
    {{ changeAttribute?.name }}
    <app-number-change
      (afterUpdate)="onAttributeUpdate($event)"
      [readPath]="changeAttribute?.dbPath"
      [writePath]="changeAttribute?.dbPath">
    </app-number-change>
  </div>
</ng-template>

<ng-template #changeAdvancementSheet>
  <div class="action-sheet">
    {{ changeAttribute?.name }}
    <app-number-change
      (afterUpdate)="onAdvancementUpdate($event, changeAttribute?.name)"
      [readPath]="changeAttribute?.dbPath"
      [writePath]="changeAttribute?.dbPath">
    </app-number-change>
  </div>
</ng-template>

<ng-template #removeResourcesSheet>
  <div class="action-sheet flex-column">
    <div>Remove Resources</div>
    <ng-number-picker
      #removeResourcePicker
      class="number-picker"
      [arrowKeys]="true"
      [min]="0">
    </ng-number-picker>
    <button (click)="removeResources(removeResourcePicker.value)">
      Confirm
    </button>
  </div>
</ng-template>

<ng-template #addResourcesSheet>
  <div class="action-sheet flex-column">
    <div>Add Resources</div>
    <ng-number-picker
      #addResourcePicker
      class="number-picker"
      [arrowKeys]="true"
      [min]="0">
    </ng-number-picker>
    <button (click)="addResources(addResourcePicker.value)">
      Confirm
    </button>
  </div>
</ng-template>

<ng-template #transferResourcesSheet>
  <div class="action-sheet flex-column" *ngIf="calculateWealth(selectedCitizen.resources) as wealth">
    <div>Transfer to Reserve</div>
    <ng-number-picker
      #transferResourcePicker
      class="number-picker"
      [arrowKeys]="true"
      [min]="0"
      [max]="wealth"
    >
    </ng-number-picker>
    <button (click)="transferResources('reserve', transferResourcePicker.value)">
      Confirm
    </button>
  </div>
</ng-template>

<ng-template #advancementSheet>
  <div class="action-sheet flex-column">
    <div>{{changeAttribute.name}} (cost: {{ changeAttribute?.data.cost }})</div>

    <ng-container
      *ngIf="changeAttribute?.data.wealth < changeAttribute?.data.cost">
      <p>Not enough resources to buy advancement</p>
      <button (click)="actionSheet.dismiss()">Ok</button>
    </ng-container>

    <button 
      *ngIf="changeAttribute?.data.wealth >= changeAttribute?.data.cost"
      (click)="buyAdvancement(changeAttribute.name, changeAttribute.data.cost, changeAttribute.dbPath)">
      Buy
    </button>
  </div>
</ng-template>

<ng-template #localLandSheet>
  <div class="action-sheet flex-column">
    <ng-container *ngIf="changeAttribute?.data.wealth >= changeAttribute?.data.cost; else noMoney">
      <div>Purchase new land plot for citizen? (cost: {{changeAttribute.data.cost}})</div>
      <button 
        (click)="buyLocalLand(changeAttribute.data.cost, changeAttribute.dbPath)">
        Confirm
      </button>
    </ng-container>

    <ng-template #noMoney>
      Not enough resources to purchase land
    </ng-template>
  </div>
</ng-template>
