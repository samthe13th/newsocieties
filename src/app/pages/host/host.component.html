<div *ngIf="showModal === true" class="modal-wrap">
  <div class="modal small">
    <button
      class="cancel-button"
      (click)="closeModal()">
      Cancel
    </button>
    <ng-container *ngTemplateOutlet="modalContent"></ng-container>
  </div>
</div>

<app-tabs 
  class="host-side-panel"
  selectedClass="host-selected-tab"
  [tabs]="[
    { id: 'division', tabTemplate: division, bodyTemplate: divisionBody },
    { id: 'global', tabTemplate: global, bodyTemplate: globalBody },
    { id: 'io', tabTemplate: io, bodyTemplate: ioBody },
    { id: 'central', tabTemplate: central, bodyTemplate: centralBody },
    { id: 'notes', tabTemplate: notes, bodyTemplate: notesBody }
  ]">
</app-tabs>

<div class="host-main" *ngIf="focus">
  <app-button-group
    #focusButtonsComponent
    (select)="onFocusSelect($event)"
    [selectById]="focus"
    [buttons]="focusButtons">
  </app-button-group>
  <!-- <div class="button-row">
    <button (click)="setFocus('harvest')">Harvest</button>
    <button (click)="setFocus('vote')">Vote</button>
  </div> -->
  <div *ngIf="focus === 'harvest'" class="harvest-wrapper">
    <div class="turn-controls">
      <app-button-group
        *ngIf="$turn | async as turn"
        (select)="onTurnSelect($event)"
        [selectById]="turn?.index"
        [buttons]="turnButtons">
      </app-button-group>
      <app-player-turn [divisionPath]="divisionPath"></app-player-turn>
    </div>
     <app-land-grid 
      *ngIf="action === 'harvesting'"
      [markCards]="true"
      [showId]="showKey"
      [divisionKey]="divisionKey"
      [updatePath]="landTilesPath"> 
    </app-land-grid>
  </div>

  <div *ngIf="focus === 'principles' || focus === 'resolutions' || focus === 'scenerio'" class="resolution-wrapper">
    <!-- <ng-container *ngIf="action === 'funding'">
      Resolution:  {{ divisionVote?.value }}
      <button (click)="enactVoteResult()">Enact resolution</button>
      <button (click)="clearVote()">Cancel resolution</button>
    </ng-container> -->
    <ng-container *ngIf="($vote | async) as vote">
      <app-fundraising
        style="background: black"
        *ngIf="vote?.state === 'review' && vote?.type === 'resolution'"
        [showKey]="showKey"
        [divisionKey]="divisionKey"
        [isCentral]="true"
        (fundsChange)="onFundsChange($event)"
        >
      </app-fundraising>
      <app-vote 
        (selectionChange)="onSelectionChange($event)"
        [showVotes]="true"
        [allowSelection]="vote?.state === 'review'"
        [showId]="showKey"
        role="central"
        [divisionId]="divisionKey"
      ></app-vote>
      <button *ngIf="vote?.state === 'voting'" (click)="closePolls()">Close Polls</button>
      <button *ngIf="vote?.state === 'review' && divisionVote" (click)="implement()">Implement</button>
    </ng-container>

  </div>
</div>

<app-notification-feed
  [showKey]="showKey"
  [divisionKey]="divisionKey">
</app-notification-feed>

<ng-template #harvestTemplate>
  Go to harvest
  <button (click)="startHarvest()">Start</button>
</ng-template>

<ng-template #principleTemplate>
  <h1>Principle</h1>
  <select
    *ngIf="voteDropdown"
    [(ngModel)]="voteDropdownSelect"
    name="vote-options"
    id="vote-options">
    <option
      *ngFor="let option of voteDropdown"
      [ngValue]="option">
      {{option?.title}}
    </option>
  </select>

  <button *ngIf="voteDropdownSelect" (click)="startVote('principles')">Vote on Principle</button>
</ng-template>

<ng-template #resolutionTemplate>
  Resolution
  <select
    *ngIf="voteDropdown"
    [(ngModel)]="voteDropdownSelect"
    name="vote-options"
    id="vote-options">
    <option
      *ngFor="let option of voteDropdown"
      [ngValue]="option">
      {{option?.title}}
    </option>
  </select>

  <button *ngIf="voteDropdownSelect" (click)="startVote('resolutions')">Vote on Resolution</button>
</ng-template>

<ng-template #scenerioTemplate>
  Scenerio
  <button *ngIf="voteDropdownSelect" (click)="startVote('scenerio')">Vote on Scenerio</button>
</ng-template>

<!-- TABS-->
<ng-template #division>{{divisionKey}}</ng-template>
<ng-template #global>Global</ng-template>
<ng-template #io>I/O</ng-template>
<ng-template #central>Central</ng-template>
<ng-template #notes>Notes</ng-template>

<!-- DIVISION -->
<ng-template #divisionBody>
  <div class="stack" *ngIf="$division | async as division">
    <div class="tab-card">
      <h2>Division</h2>

      <div><strong>Score: </strong>{{ division.score }}</div>
      <div><strong>Season:</strong>
        {{ division.season }}
        <button (click)="newSeason(division)">New Season</button>
      </div>

      <hr/>
      <div>
        <strong>Land cost: </strong>
        {{ division.landCost }}
      </div>
      <div><strong>Harvested: </strong>
        {{ division.harvested }} <span *ngIf="division.harvested">({{ percentHarvested(division.harvested, division.capacity) }}% of capacity)</span>
      </div>
      <div>
        <strong>Capacity: </strong>
        {{ division?.capacity }}
      </div>
      <div><strong>Harvest:</strong>
        {{ division?.harvest }}
      </div>

      <div>
        <strong>Reserve thresholds</strong>
        <div class="indented-list">
          <div>
            <strong>High: </strong>{{ division?.reserveThresholds.high }}
          </div>
          <div>
            <strong>Mid: </strong>{{ division?.reserveThresholds.mid }}
          </div>
          <div>
            <strong>Low: </strong>{{ division?.reserveThresholds.low }}
          </div>
        </div>
      </div>

      <hr/>

      <div>
        <div>
          <strong>Reserve: </strong>
          {{ division.reserve }}
          <button (click)="changeDivisionProperty('reserve')">Change</button>
        </div>
        <strong>Advancements</strong>
        <div class="indented-list">
          <div>
            <strong>Arts: </strong>{{ division.advancements.arts.individual + division.advancements.arts.communal }} [{{ division.advancements.arts.communal }}]
            <button (click)="changeDivisionProperty('advancements/arts/communal', 'communal arts')">Change</button>
          </div>
          <div>
            <strong>Health: </strong>{{ division.advancements.health.individual + division.advancements.health.communal }} [{{ division.advancements.health.communal }}]
            <button (click)="changeDivisionProperty('advancements/health/communal', 'communal health')">Change</button>
          </div>
          <div>
            <strong>Safety: </strong>{{ division.advancements.safety.individual + division.advancements.safety.communal }} [{{ division.advancements.safety.communal }}]
            <button (click)="changeDivisionProperty('advancements/safety/communal', 'communal safety')">Change</button>
          </div>
          <div>
            <strong>Knowledge: </strong>{{ division.advancements.knowledge.individual + division.advancements.knowledge.communal }} [{{ division.advancements.knowledge.communal }}]
            <button (click)="changeDivisionProperty('advancements/knowledge/communal', 'communal knowledge')">Change</button>
          </div>
          <div>
            <strong>Infastructure: </strong>{{ division.advancements.infastructure.individual + division.advancements.infastructure.communal }} [{{ division.advancements.infastructure.communal }}]
            <button (click)="changeDivisionProperty('advancements/infastructure/communal', 'communal infastructure')">Change</button>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-card">
      <h2>Citizens</h2>
      <div *ngFor="let citizen of division.citizens">
        <div><strong>{{citizen.id}}</strong>: <button>{{citizen.name}}</button></div>
        <div><strong>Resources: </strong>{{ citizen.resources?.length }}</div>
      </div>
    </div>

    <div class="tab-card">
      <h2>Principles</h2>
      <p *ngFor="let principle of ($principles | async)">
        {{ principle.value }}
      </p>
    </div>

    <div class="tab-card">
      <h2>Resolutions</h2>
      <p *ngFor="let resolution of ($resolutions | async)">
        {{ resolution.value }}
      </p>
    </div>

    <div class="tab-card">
      <h2>Scenerios</h2>
      <p *ngFor="let scenerio of ($scenerios | async)">
        {{ scenerio.value }}
      </p>
    </div>

    <ng-template #newSeasonTemplate>
      <div *ngIf="division.nextSeason as next">
        <h1>New Season: <span class="new-value">{{ next?.season }}</span></h1>
        <div>Capacity: {{ division.capacity }} &#8594; <span class="new-value">{{ next?.capacity }}</span></div>
        <div>Harvest: {{ division.harvest }} &#8594; <span class="new-value">{{ next?.harvest }}</span></div>
        <div>Thresholds:
          ({{ division.reserveThresholds.low }}, {{ division.reserveThresholds.mid }}, {{ division.reserveThresholds.high }})
          &#8594; <span class="new-value">({{ next?.thresholds[0] }}, {{ next?.thresholds[1] }}, {{ next?.thresholds[2] }})</span>
        </div>
        <div>Land Cost: {{ division.landCost }} &#8594; <span class="new-value">{{ next?.landCost }}</span></div>
        <button (click)="startSeason(division, next)">Start Season</button>
      </div>
    </ng-template>
  </div>

</ng-template>

<!-- GLOBAL -->
<ng-template #globalBody>
  <span *ngIf="contamination !== undefined">
    Contamination Level: {{contamination}}%
  </span>
</ng-template>

<!-- I/O -->
<ng-template #ioBody>
  I/O
</ng-template>

<!-- CENTRAL -->
<ng-template #centralBody>
  <app-chat [sender]="divisionKey" [feedName]="divisionKey" [showKey]="showKey"></app-chat>
  <textarea
    (keydown.enter)="submitChat(divisionKey)"
    class="host-chat-input"
    name="chatInput"
    type="text"
    [(ngModel)]="chatInput">
  </textarea>
  <button class="host-chat-button" (click)="submitChat(divisionKey)">SEND</button>
</ng-template>

<!-- NOTES -->
<ng-template #notesBody>
  <div class="button-row">
    <button [style.font-size.px]="14" (click)="fontSizeDown()">Aa</button>
    <button [style.font-size.px]="20" (click)="fontSizeUp()">Aa</button>
  </div>
  <br/>
  <textarea [style.font-size.px]="fontSize" class="host-notes">Type notes here!</textarea>
</ng-template>

<!-- UPDATE SHEET -->
<ng-template #updateSheet>
  <div class="action-sheet">
    {{ changeAttribute?.name }}
    <app-number-change
      (afterUpdate)="onAttributeUpdate($event)"
      [readPath]="changeAttribute?.dbPath"
      [writePath]="changeAttribute?.dbPath">
    </app-number-change>
  </div>
</ng-template>