<ng-container *ngIf="($division | async) as division">
  <div class="player-turn">
    <app-player-turn 
      (turnChange)="onTurnChange($event)"
      [divisionPath]="divisionPath"></app-player-turn>
  </div>
  <app-tabs
    selectedClass="player-selected-tab"
    [tabs]="[
      { id: 'division', tabTemplate: divisionTab, bodyTemplate: divisionBody },
      { id: 'global', tabTemplate: global, bodyTemplate: globalBody }
    ]"
  ></app-tabs>

  <ng-template #divisionTab>
    <div class="player-folder__tab-division">
      {{ division?.code }}
    </div>
    <h1>Season {{ division?.season }}: {{division?.focus}}</h1>
  </ng-template>

  <ng-template #global>Global</ng-template>

  <ng-template #divisionBody>
    <ng-container *ngIf="focus === 'harvest'">
      <div class="player-hints"></div>
      <div class="flex-row">
        <div class="player-folder__body-harvest">
          <app-land-grid 
            #landGrid
            [markCards]="false"
            [turn]="$turn | async"
            [updatePath]="landTilesPath"
            [showId]="showKey"
            [divisionKey]="divisionKey"
            [playerId]="id"
            (gatherResource)="onGather($event)"
            (select)="onSelect($event)"
          ></app-land-grid>
        </div>
        <div class="player-folder__body-citizens space-between">
          <div class="harvest-details">
            <div class="flex-column stretch-h">
              <div class="large">Reserve: <span class="harvest-details__number">{{division?.reserve}}</span></div>
              <div class="flex-column stretch-h">
                <div>Thresholds</div>
                <div>
                  <span class="harvest-details__number">
                    {{division?.reserveThresholds.low}}
                    | {{division?.reserveThresholds.mid}}
                    | {{division?.reserveThresholds.high}}
                  </span>
                </div>
              </div>
            </div>
            <div class="flex-column stretch-h">
              <div class="large">Harvested: <span class="harvest-details__number">{{division?.harvested}}</span></div>
              <div class="flex-column stretch-h">
                <div>Capacity</div>
                <div>
                  <span class="harvest-details__number">
                    {{division?.capacity}}<span style="font-size: 16px">+{{division?.extra}}</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
           
          <app-player-deck
            [id]="id" 
            [myTurn]="id == ($turn | async)?.playerId"
            [showKey]="showKey"
            [division]="division">
          </app-player-deck>

          <div class="citizen-list">
            <div 
              class="citizen-summary flex-row space-between"
              *ngFor="let citizen of filterOutCitizen(division.citizens, id)">
              <div class="flex-row flex-center-v">
                <span [class.player-turn-indicator]="citizen.id == ($turn | async)?.playerId">{{citizen.name}}</span>
                <span>{{calculateWealth(citizen?.resources)}}</span>
                <!-- <app-player-turn 
                  [showLabel]="false"
                  [divisionPath]="divisionPath">
                </app-player-turn> -->
              </div>
              <!-- <div *ngIf="citizen">
                {{ addResources(citizen.resources) }}
              </div> -->
            </div>
          </div>
    
          <!-- <button (click)="buy({ cost: 2 })">Spend $2</button>
          <button (click)="buy({ cost: 5 })">Spend $5</button>
          <button (click)="buy({ cost: 6 })">Spend $6</button> -->
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="focus === 'resolutions' || focus === 'principles'">
      <div class="flex-row">
        <div class="relative-position">
          <div class="tab-background voting blur" >
            <img src="assets/voting-ph.jpeg"/>
          </div>
    
          <div class="tab-foreground player-vote">
            <div *ngIf="hasVoted && vote?.state === 'voting'">Thanks for voting! Waiting for polls to close...</div>
            <ng-container *ngIf="!(hasVoted && vote?.state === 'voting')">
              <app-vote
                (selectionChange)="onSelectionChange($event)"
                [showVotes]="vote?.state === 'review'"
                [allowSelection]="vote?.state === 'voting'"
                [showId]="showKey"
                role="citizen"
                hideOption="last"
                [divisionId]="division.code"
              ></app-vote>
              <button *ngIf="!hasVoted && vote?.state === 'voting'" (click)="castVote()">Vote</button>
            </ng-container>
          </div>
        </div>
        <div>
          <app-fundraising
            *ngIf="vote?.state === 'review'"
            [showKey]="showKey"
            [divisionKey]="divisionKey"
            [playerId]="id">
          </app-fundraising>
        </div>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #globalBody>
    <app-society-grid></app-society-grid>
  </ng-template>

  <ng-template #tileSelectSheet>
    <div class="action-sheet">
      {{ selectedResourceStatus?.message }}
      <div 
        *ngIf="selectedResourceStatus?.status === 'explorable'" 
        class="large-action-button"
        (click)="explore()">
        <fa-icon size="lg" [icon]="exploreIcon"></fa-icon>
        Explore (e)
      </div>
      <div 
        *ngIf="selectedResourceStatus?.status === 'explored' || selectedResourceStatus?.status === 'explorable'"
        class="large-action-button"
        (click)="gather()">
        <fa-icon size="lg" [icon]="gatherIcon"></fa-icon>
        Gather (g)
      </div>
    </div>
  </ng-template>

</ng-container>